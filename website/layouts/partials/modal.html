{{ $form_id_array := slice }}

<script src="https://lp.datadoghq.com/js/forms2/js/forms2.min.js"></script>

{{ range $index, $form := .form }}
{{ $form_id_array = $form_id_array | append $form.form_id }}
<div id={{ $form.form_id }} class="hidden bg-black bg-opacity-50 z-50 fixed top-0 left-0 w-full h-full overflow-auto">
    <div class="max-w-full md:max-w-2xl w-auto mx-auto my-6 px-2.5 py-2">
        <div id="modal-container--{{ $form.form_id }}" class="bg-white rounded flex flex-col">
            <div class="relative text-center p-4 flex items-start justify-between">
                <p class="w-4/5 m-auto text-dark text-lg font-semibold">
                    {{ $form.form_title }}
                </p>
                <button id="modal-close--{{ $form.form_id }}" type="button" data-dismiss="modal"
                    class="close absolute right-4 p-4 pt-3 -m-4 ml-auto font-semibold opacity-50">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="relative flex flex-auto px-2 pb-4 justify-center">
                <form id="mktoForm_{{ $form.form_id }}"></form>
            </div>
        </div>
    </div>
</div>
{{ end }}

<script>
    const { MktoForms2 } = window;
    const formIDsArray = {{ $form_id_array }};

    const loadMarketoForm = () => {
        formIDsArray.forEach(id => {
            MktoForms2.loadForm('//lp.datadoghq.com', '875-UVY-685', id, (form) => {
                const formOnPage = document.getElementById(`mktoForm_${id}`);

                formOnPage.removeAttribute("style");
                formOnPage.setAttribute("class", "mktoForm flex flex-col");

                function displayThankYouMessage(thankYouText) {
                    const thankYouMsgContainer = document.createElement('div');
                    thankYouMsgContainer.classList.add('w-full');
                    thankYouMsgContainer.innerHTML = thankYouText;
                    formOnPage.classList.add('hidden');
                    // hide signup header upon form submission
                    const signUpHeader = document.querySelector(`#modal-container--${id} > div > p`);
                    signUpHeader.classList.add('hidden');

                    formOnPage.parentNode.appendChild(thankYouMsgContainer);
                }

                form.onSuccess((values, followUpUrl) => {
                    displayThankYouMessage("Thank you for joining our Updates Newsletter");
                })
            });
        });
    };

    /* If User clicks CTA button, show modal */
    const toggleModal = (id) => {
        event.preventDefault();

        const modal = document.getElementById(id);
        const modalVisible = document.getElementById(`modal-container--${id}`);
        const buttonExit = document.getElementById(`modal-close--${id}`);

        /* If User clicks outside modal or on "X", hide modal & removeEventListener */
        const handleModalClick = () => {
            if (!modalVisible.contains(event.target) || buttonExit.contains(event.target)) {
                modal.classList.toggle("hidden");
                modal.removeEventListener("click", handleModalClick);
            }
        }

        modal.classList.toggle("hidden");

        modal.addEventListener("click", handleModalClick);
    };

    window.addEventListener("load", loadMarketoForm);
</script>